commit e108a795efad9b7c5e83d3cb3cb45301f9fb58f9
Author: Turbo Fredriksson <turbo@bayour.com>
Date:   Fri Sep 5 23:29:36 2014 +0200

    Allow for "zfs receive" to skip existing snapshots
    by adding the option "-s" to zfs receive.
    
    Signed-off-by: Turbo Fredriksson <turbo@bayour.com>
    
    Closes: #2666

Index: pkg-zfs/cmd/zfs/zfs_main.c
===================================================================
--- pkg-zfs.orig/cmd/zfs/zfs_main.c	2016-03-29 17:13:42.717582020 +0200
+++ pkg-zfs/cmd/zfs/zfs_main.c	2016-03-29 17:17:21.097576766 +0200
@@ -247,7 +247,7 @@
 	case HELP_PROMOTE:
 		return (gettext("\tpromote <clone-filesystem>\n"));
 	case HELP_RECEIVE:
-		return (gettext("\treceive [-vnFu] [-d | -e] [-o <property>] "
+		return (gettext("\treceive [-vnFus] [-d | -e] [-o <property>] "
 		    "... [-x <property>] ... [-l <filesystem|volume>] ... "
 		    " <filesystem|volume|snapshot>\n"));
 	case HELP_RENAME:
@@ -3872,7 +3872,7 @@
 }
 
 /*
- * zfs receive [-vnFu] [-d | -e] [-l <volume|filesystem>] ...
+ * zfs receive [-vnFus] [-d | -e] [-l <volume|filesystem>] ...
  * [-o property=value] ... [-x property] ... <volume|filesytem|snapshot>
  *
  * Restore a backup stream from stdin.
@@ -3889,7 +3889,7 @@
 		nomem();
 
 	/* check options */
-	while ((c = getopt(argc, argv, ":del:no:uvx:F")) != -1) {
+	while ((c = getopt(argc, argv, ":del:no:uvx:Fs")) != -1) {
 		switch (c) {
 		case 'd':
 			flags.isprefix = B_TRUE;
@@ -3913,6 +3913,9 @@
 				goto recverror;
 			}
 			break;
+		case 's':
+			flags.skip = B_TRUE;
+			break;
 		case 'u':
 			flags.nomount = B_TRUE;
 			break;
Index: pkg-zfs/include/libzfs.h
===================================================================
--- pkg-zfs.orig/include/libzfs.h	2016-03-29 17:13:42.717582020 +0200
+++ pkg-zfs/include/libzfs.h	2016-03-29 17:14:25.625580988 +0200
@@ -686,6 +686,9 @@
 
 	/* do not mount file systems as they are extracted (private) */
 	boolean_t nomount;
+
+	/* skip existing snapshots */
+	boolean_t skip;
 } recvflags_t;
 
 extern int zfs_receive(libzfs_handle_t *, const char *, recvflags_t *,
Index: pkg-zfs/lib/libzfs/libzfs_sendrecv.c
===================================================================
--- pkg-zfs.orig/lib/libzfs/libzfs_sendrecv.c	2016-03-29 17:13:42.721582020 +0200
+++ pkg-zfs/lib/libzfs/libzfs_sendrecv.c	2016-03-29 17:15:36.933579272 +0200
@@ -3053,13 +3053,14 @@
 		zfs_handle_t *zhp;
 
 		/*
-		 * Destination fs exists.  Therefore this should either
+		 * Destination fs exists (and we have not been asked to
+		 * skip existing snapshots). Therefore this should either
 		 * be an incremental, or the stream specifies a new fs
 		 * (full stream or clone) and they want us to blow it
 		 * away (and have therefore specified -F and removed any
 		 * snapshots).
 		 */
-		if (stream_wantsnewfs) {
+		if (stream_wantsnewfs && !flags->skip) {
 			if (!flags->force) {
 				zcmd_free_nvlists(&zc);
 				zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,
@@ -3164,7 +3165,17 @@
 	zc.zc_begin_record = drr_noswap->drr_u.drr_begin;
 	zc.zc_cookie = infd;
 	zc.zc_guid = flags->force;
-	skip = limitds && !nvlist_exists(limitds, dsname);
+
+	if (zfs_dataset_exists(hdl, zc.zc_value, ZFS_TYPE_SNAPSHOT) &&
+	    flags->skip) {
+		(void) printf("skipping snapshot %s - %s already exists\n",
+				drrb->drr_toname, zc.zc_value);
+		(void) fflush(stdout);
+
+		zcmd_free_nvlists(&zc);
+		return (recv_skip(hdl, infd, flags->byteswap));
+	}
+
 	if (flags->verbose) {
 		(void) printf("%s %s stream of %s into %s\n",
 		    skip ? (flags->dryrun ? "would skip" : "skipping") :
Index: pkg-zfs/man/man8/zfs.8
===================================================================
--- pkg-zfs.orig/man/man8/zfs.8	2016-03-29 17:13:42.689582021 +0200
+++ pkg-zfs/man/man8/zfs.8	2016-03-29 17:14:25.633580988 +0200
@@ -184,12 +184,12 @@
 
 .LP
 .nf
-\fBzfs\fR \fBreceive | recv\fR [\fB-vnFu\fR] \fIfilesystem\fR|\fIvolume\fR|\fIsnapshot\fR
+\fBzfs\fR \fBreceive | recv\fR [\fB-vnFus\fR] \fIfilesystem\fR|\fIvolume\fR|\fIsnapshot\fR
 .fi
 
 .LP
 .nf
-\fBzfs\fR \fBreceive | recv\fR [\fB-vnFu\fR] [\fB-d\fR|\fB-e\fR] \fIfilesystem\fR
+\fBzfs\fR \fBreceive | recv\fR [\fB-vnFus\fR] [\fB-d\fR|\fB-e\fR] \fIfilesystem\fR
 .fi
 
 .LP
@@ -3179,11 +3179,11 @@
 .ne 2
 .mk
 .na
-\fB\fBzfs receive\fR [\fB-vnFu\fR] \fIfilesystem\fR|\fIvolume\fR|\fIsnapshot\fR\fR
+\fB\fBzfs receive\fR [\fB-vnFus\fR] \fIfilesystem\fR|\fIvolume\fR|\fIsnapshot\fR\fR
 .ad
 .br
 .na
-\fB\fBzfs receive\fR [\fB-vnFu\fR] [\fB-d\fR|\fB-e\fR] \fIfilesystem\fR\fR
+\fB\fBzfs receive\fR [\fB-vnFus\fR] [\fB-d\fR|\fB-e\fR] \fIfilesystem\fR\fR
 .ad
 .sp .6
 .RS 4n
@@ -3262,6 +3262,33 @@
 Force a rollback of the file system to the most recent snapshot before performing the receive operation. If receiving an incremental replication stream (for example, one generated by \fBzfs send -R -[iI]\fR), destroy snapshots and file systems that do not exist on the sending side.
 .RE
 
+.sp
+.ne 2
+.na
+\fB\fB-e\fR\fR
+.ad
+.sp .6
+.RS 4n
+Generate a more compact stream by using WRITE_EMBEDDED records for blocks
+which are stored more compactly on disk by the \fBembedded_data\fR pool
+feature.  This flag has no effect if the \fBembedded_data\fR feature is
+disabled.  The receiving system must have the \fBembedded_data\fR feature
+enabled.  If the \fBlz4_compress\fR feature is active on the sending system,
+then the receiving system must have that feature enabled as well. See
+\fBzpool-features\fR(5) for details on ZFS feature flags and the
+\fBembedded_data\fR feature.
+.RE
+
+.sp
+.ne 2
+.mk
+.na
+\fB\fB-s\fR\fR
+.ad
+.sp .6
+.RS 4n
+Skip existing snapshots in a stream.
+.RE
 .RE
 
 .sp
